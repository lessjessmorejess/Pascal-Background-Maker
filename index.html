<!DOCTYPE html>
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <style>

  </style>

</head>
<body>
  <label></label>
  <select id="resolution" class="update">
   <optgroup label="iPhone">
    <option value="iPhone Xs Max/11 Pro Max">iPhone Xs Max/11 Pro Max (1242 x 2688)</option>
    <option value="iPhone Xr/11">iPhone Xr/11 (828 x 1792)</option>
    <option value="iPhone X/Xs/11 Pro">iPhone X/Xs/11 Pro (1125 x 2436)</option>
    <option value="iPhone 8+/7+/6s+/6+">iPhone 8+/7+/6s+/6+ (1080 x 1920)</option>
    <option value="iPhone 8/7/6s/6">iPhone 8/7/6s/6 (750 x 1334)</option>
    <option value="iPhone 5/5c/5s/SE">iPhone 5/5c/5s/SE (640 x 1136)</option>
  </select>
  <select id="position" class="update">
    <option value="0">Top Text</option>
    <option value="1">Bottom Text</option>
  </select>
  <select id="theme" class="update">
    <option value="0">Light</option>
    <option value="1">Dark</option>
  </select>
  <select id="category" class="update">Category
    <option value="New Horizons">New Horizons</option>
    <option value="New Leaf">New Leaf</option>
    <option value="User">User</option>
    <option value="Random">Random</option>
  </select>
  <input id="inp" class="update" placeholder="Enter text here"></input>
  <button id="newQuote">Hit me</button>
  <button>Make it, maaan</button>
  <br>
  <h1 id="quote"></h1>
  <canvas id="canvas" />

</body>
  <script>
  //Initial declares
  var quotes = []
  var horizons = []
  var leaf = []
  var user = []
  var r
  //Declare the foundational variables
  var pascalLW = {
      "width": 2048,
      "height": 2732
    };

  //Get the images from the assets folder.
  var bubbleImg = new Image();
      bubbleImg.src = "assets/bubble_crop.png"
  var pascalDayImg = new Image();
      pascalDayImg.src = "assets/pascal_day.png"
  var pascalNightImg = new Image();
      pascalNightImg.src = "assets/pascal_night.png"
  var lightDayImg = new Image();
      lightDayImg.src = "assets/light_day.png"
  var lightNightImg = new Image();
      lightNightImg.src = "assets/light_night.png"
  var waterDayImg = new Image();
      waterDayImg.src = "assets/water_day.png"
  var waterNightImg = new Image();
      waterNightImg.src = "assets/water_night.png"


  var textColor = "#00cbda"
  var textFont  = "bold 85px Arial" //TODO get arial rounded in this. 90px is correct relative to the quote image size.

  var canvas = document.getElementById('canvas'),
        ctx = canvas.getContext('2d');
        canvas.crossOrigin = "Anonymous";

  //would make these jquery but need document on load
  var submissionElement  = document.getElementById("inp")
  var resolutionElement  = document.getElementById("resolution")
  var positionElement    = document.getElementById("position")
  var themeElement       = document.getElementById("theme")
  var categoryElement    = document.getElementById("category")

  //Declare default values
  var text      = "Hey maaan."
  var inputText = submissionElement.value
  var model     = resolutionElement.value
  var position  = positionElement.value
  var theme     = themeElement.value
  var category  = categoryElement.value


  function BuildFinal(){
      document.getElementById("quote").textContent = "'" + text + "'"
    //Get relevant variables
      deviceW = resolutions[model].width
      deviceH = resolutions[model].height
      //scaleMatch should be the ratio to make the scaling 1:1
      var scaleMatch = deviceH/pascalLW.height
      //TODO figure out how scaleSmall is useful
      var scaleSmall = deviceW/pascalLW.width
      //scaleBubble is made to fit the bubble to the screen
      var scaleBubble = deviceW/bubbleImg.width;

      console.log("bubbleImg.width is " + bubbleImg.width)
      console.log("deviceW is " + deviceW)
      console.log("scaleBubble is " + scaleBubble)
      console.log("scaleMatch is " + scaleMatch)

      //These variables are for placing the images in the correct spot
        startXlarge = (((deviceW - pascalLW.width)/2) * scaleMatch)
        startYlarge = (((pascalLW.height - deviceH)/2) * scaleMatch)
        startXsmall = (((pascalLW.height - deviceH)/2) * scaleSmall)
        startYsmall = (((pascalLW.width  - deviceW)/2) * scaleSmall)

    //Build the canvas
      //Set the canvas dimensions & scale to match the selected model
        canvas.setAttribute("width",  deviceW)
        canvas.setAttribute("height", deviceH)

        ctx.scale(scaleMatch, scaleMatch)
        ctx.clearRect(0, 0, deviceW, deviceH);

      //Draw the image layers
      //ctx.drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);
        ctx.drawImage(thisWaterImg, startXlarge, 0);
        ctx.drawImage(thisPascalImg, startXlarge, -startYsmall);
        ctx.drawImage(thisLightImg, startXlarge, 0);

      //change the drawing scale so the text bubble can fit properly in the window

        //the current scale must be undone to properly scale the bubble.
        ctx.scale(1/scaleMatch,1/scaleMatch)
        ctx.scale(scaleBubble,scaleBubble)
        ctx.drawImage(bubbleImg, 0, 0);

        //refill text
          ctx.fillStyle = textColor;
          ctx.font = textFont
          ctx.textBaseline = "top"


          //fillText(text, x, y [, maxWidth]);
          //TODO wrapping will need to be handled manually
          //https://www.html5canvastutorials.com/tutorials/html5-canvas-wrap-text-tutorial/
          //These values work when the bubble is at (0,0) and scale to the bubble properly with the size of the canvas

          /*Currently testing the bubble with the following quote:
            "Do Roosters go back to sleep after they wake everyone up? I mean, they're pretty much done for the day."
            Reference image found here:
            https://www.google.com/search?q=acnh+pascal&client=firefox-b-1-d&sxsrf=ALeKk00KEA5R_N5YMXepfQJzlnfStfvl4w:1607907023662&source=lnms&tbm=isch&sa=X&ved=2ahUKEwiGjOi3oMztAhVSk1kKHTNDBbAQ_AUoAnoECBQQBA&biw=1680&bih=848#imgrc=FWamWedBGIxN8M
          */
          var testLine = "Do Roosters go back to sleep after they wake everyone up? I mean, they're pretty much done for the day."

          //TODO allow the user to adjust the maxLength, and maybe even the font size?
          //There's no way to ensure that all text will always fit perfectly
          var lines = wrapLines(text,38,3)
          ctx.fillText(lines[0], 150, 175);
          ctx.fillText(lines[1], 150, 300);
          ctx.fillText(lines[2], 150, 425);



  }

  function BuildPreview(){
    //Generate the preview canvas
    /*TODO  the preview needs to load in roughly the same space on the page.
            it will need to scale appropriately to be accurate to the final
            AND fit in the space provided.
            Building the final will be easier, so this function calls that for now.
    */
    BuildFinal()
  }

  function ProcessVars(){

    if (loaded !== false){
      //Pulls values from the interactive elements
        inputText = submissionElement.value
        model     = resolutionElement.value
        position  = parseInt(positionElement.value)
        theme     = parseInt(themeElement.value)


      //If the user does not have text in the text input field
        if (inputText === ""){
          //generate a random number, apply that to the number of quotes in a section
          //and deliver the corresponding number.
          switch (category){
            case "New Horizons":
              chosenQuote = Math.floor(horizons.length * r)
              text = horizons[chosenQuote];
              break;
            case "New Leaf":
              chosenQuote = Math.floor(leaf.length * r)
              text = leaf[chosenQuote];
              break;
            case "user":
              chosenQuote = Math.floor(user.length * r)
              text = user[chosenQuote];
              break;
          }
        }
        //Otherwise, use the user's input text.
        else{
          text = inputText
        }

      //Change the images used to render based on the user's selected theme
        thisWaterImg  = theme ? waterNightImg  : waterDayImg;
        thisPascalImg = theme ? pascalNightImg : pascalDayImg;
        thisLightImg  = theme ? lightNightImg  : lightDayImg;

      return
    }
  }

  function getRandomItem(item){
    //TODO: some quotes call for random items. Examples are:
    /* fruit, object, sweet food, savory food, doing random hobby*/
  }
  //TODO: This doesn't account for quotes that may be too short
  function wrapLines(string,maxLength,numberOfLines){
    var line = []
    if (string.length > maxLength){
      //console.log("wrapping");
      //Get an array of the string by word
      //Create a working string variable
      var tempString = string;
      //If tempString starts with a space, keeping removing spaces until it does not.
          while (tempString.substring(0,1) == " "){
            tempString = tempString.substring(1,tempString.length)
          }
      var strSpaceless = tempString.split(" ");
      //console.log(strSpaceless)


      //For each line until max lines are hit, do the following
      for (lineNum = 0; lineNum < numberOfLines; lineNum++){
        //console.log("currently on lineNum " + lineNum)
        //console.log(line[lineNum])
        //At the beginning of each line, set linebreak to false
        var linebreak = false;
        //set chars back to zero as the tempString is shortened on each line
        var chars = 0;

        //If tempString starts with a space, keeping removing spaces until it does not.
        while (tempString.substring(0,1) == " "){
          tempString = tempString.substring(1,tempString.length)
        }

        //If it's not the last line, try to break the line.
        if (lineNum !== (numberOfLines-1)){

          //Itterate through all the words until a word would meet the linebreak requirements
          for (word = 0; linebreak != true;){
            //This line of code is useless, but I don't know why

            //Get the length of the current word
            tempCharCount = strSpaceless[word].length;
              console.log(strSpaceless[word] +" is this many characters long: " + tempCharCount)
              console.log("tempCharCount is " + tempCharCount)
              console.log("chars is " + chars)

            //If this word does not break the line check if adding a space would break the line.
            if ((tempCharCount + chars) < maxLength){
              tempCharCount += 1;
              //If adding a space does not break the line, add the length word & the space to chars
              if ((tempCharCount + chars) <= maxLength){
                chars += tempCharCount
              }
              //If the space breaks the line, just add the word and break the line
              else{
                chars += tempCharCount
                linebreak = true;
              }
            }
            //If the word would break the line, break the line
            else{
              linebreak = true;
              //Add the current temptString to the current line based on the number of characters of words that fit.
              line.push(tempString.substring(0,chars));
              //If this line is empty
              if (line[lineNum] === ""){
                line[lineNum] = tempString.substring(0,strSpaceless[0].length + 1);
              }
              //update the temp string to omit this line
              tempString = tempString.replace(line[lineNum],"")
              if (tempString)
              //Update the word array to omit this line.
              strSpaceless = tempString.split(" ");
            }
            word++;
          }
        }
        //If it's the last line, just place the rest of the text.
        else{
          line.push(tempString);
        }
        console.log("finished with lineNum " + lineNum)
        console.log("'" + line[lineNum] + "'")
      }
      return line;
    }
  }

  //Get the JSON file of quotes and resolutions
  fetch('quotes.json')
  .then(response => response.json())
  .then(data => {
    quotes = data
    horizons = quotes["Horizons"]
    leaf = quotes["Leaf"]
    user = quotes["User"]

    fetch('resolutions.json')
    .then(r_response => r_response.json())
    .then(r_data => {
      resolutions = r_data
      loaded = true;
      r = Math.random()
      ProcessVars();
      BuildFinal()
    });
  });


  //When an option is updated, update the preview
  $(document).on('input','.update',function(){
    ProcessVars()
    BuildFinal()
    //TODO separate preview & final
    //BuildPreview()
  });
  $('#newQuote').click(function(){
    r = Math.random()
    ProcessVars()
  })

  //When the button submit is clicked, create the final result
  $('button').click(function(){
    ProcessVars()
    BuildFinal()

  });
  </script>
</html>
